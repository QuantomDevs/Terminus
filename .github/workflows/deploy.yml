name: Deploy Docker Images

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_variant:
        description: "Which variant to build"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - backend
          - web
          - full

jobs:
  # ============================================
  # Docker Image Builds
  # ============================================
  publish:
    name: Build and Publish Docker Images
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
    runs-on: ubuntu-latest

    strategy:
      matrix:
        variant: [backend, web, full]

    steps:
      - name: Skip if not building this variant
        if: github.event.inputs.build_variant != 'all' && github.event.inputs.build_variant != matrix.variant
        run: |
          echo "Skipping ${{ matrix.variant }} build"
          exit 0

      - name: Checkout git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for release notes

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"

      - name: Fetch all tags
        run: git fetch --all --tags

      - name: Version Check
        uses: thebongy/version-check@v2
        with:
          file: package.json
          tagFormat: v${version}
          failBuild: false
        id: version_check

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set repository name lowercase
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build & Push ${{ matrix.variant }} Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: ${{ matrix.variant }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}:${{ matrix.variant }}
            ghcr.io/${{ env.REPO_LOWER }}:${{ matrix.variant }}-v${{ steps.package_version.outputs.version }}
            ghcr.io/${{ env.REPO_LOWER }}:${{ matrix.variant }}-${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}
          build-args: |
            BUILDPLATFORM=${{ runner.os }}
            VERSION=${{ steps.package_version.outputs.version }}

      - name: Add additional 'latest' tag for web variant
        if: matrix.variant == 'web'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: web
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}:latest
            ghcr.io/${{ env.REPO_LOWER }}:v${{ steps.package_version.outputs.version }}
          cache-from: type=gha,scope=web
          build-args: |
            BUILDPLATFORM=${{ runner.os }}
            VERSION=${{ steps.package_version.outputs.version }}

  # ============================================
  # Electron App Builds
  # ============================================
  build-electron-windows:
    name: Build Electron App (Windows)
    runs-on: windows-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Windows Portable
        run: npm run build:win-portable

      - name: Build Windows Installer
        run: npm run build:win-installer

      - name: Create Windows Portable zip
        run: |
          Compress-Archive -Path "release/win-unpacked/*" -DestinationPath "Terminus-Windows-Portable.zip"

      - name: Upload Windows Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-Windows-Portable
          path: Terminus-Windows-Portable.zip
          retention-days: 90

      - name: Upload Windows Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-Windows-Installer
          path: release/*.exe
          retention-days: 90

  build-electron-linux:
    name: Build Electron App (Linux)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Linux AppImage
        run: npm run build:linux-appimage

      - name: Build Linux tar.gz
        run: npm run build:linux-targz

      - name: Create Linux Portable zip
        run: npm run build:linux-portable

      - name: Package Linux Portable
        run: |
          cd release/linux-unpacked
          zip -r ../../Terminus-Linux-Portable.zip *
          cd ../..

      - name: Upload Linux AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-Linux-AppImage
          path: release/*.AppImage
          retention-days: 90

      - name: Upload Linux tar.gz Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-Linux-targz
          path: release/*.tar.gz
          retention-days: 90

      - name: Upload Linux Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-Linux-Portable
          path: Terminus-Linux-Portable.zip
          retention-days: 90

  build-electron-macos:
    name: Build Electron App (macOS)
    runs-on: macos-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build macOS DMG
        run: npm run build:dmg
        env:
          # Skip code signing for now (requires Apple Developer certificate)
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Find and rename DMG
        run: |
          DMG_FILE=$(find release -name "*.dmg" -type f | head -n 1)
          if [ -n "$DMG_FILE" ]; then
            cp "$DMG_FILE" "Terminus-macOS.dmg"
            echo "DMG file found and copied: $DMG_FILE"
          else
            echo "No DMG file found!"
            exit 1
          fi

      - name: Upload macOS DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Terminus-macOS-DMG
          path: Terminus-macOS.dmg
          retention-days: 90

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create GitHub Release
    needs: [publish, build-electron-windows, build-electron-linux, build-electron-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Version Check
        uses: thebongy/version-check@v2
        with:
          file: package.json
          tagFormat: v${version}
          failBuild: false
        id: version_check

      - name: Set repository name lowercase
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.version_check.outputs.versionChanged == 'true'
        run: |
          CURR_TAG="v${{ steps.package_version.outputs.version }}"

          # Generate release notes
          cat > release_notes.md << 'EOF'
          # Terminus ${{ steps.package_version.outputs.version }}

          ## Docker Images

          Terminus is available in three variants:

          ### ðŸ”§ Backend-Only (API Server)
          For separate frontend deployments or as a central API server.
          ```bash
          docker pull ghcr.io/${{ env.REPO_LOWER }}:backend
          # or specific version
          docker pull ghcr.io/${{ env.REPO_LOWER }}:backend-v${{ steps.package_version.outputs.version }}
          ```

          ### ðŸŒ Web (Recommended)
          Complete web application with UI - best for most users.
          ```bash
          docker pull ghcr.io/${{ env.REPO_LOWER }}:web
          # or use 'latest' (points to web)
          docker pull ghcr.io/${{ env.REPO_LOWER }}:latest
          # or specific version
          docker pull ghcr.io/${{ env.REPO_LOWER }}:web-v${{ steps.package_version.outputs.version }}
          ```

          ### ðŸ“¦ Full (Web + Desktop Downloads)
          Includes web UI plus Electron desktop app builds for download.
          ```bash
          docker pull ghcr.io/${{ env.REPO_LOWER }}:full
          # or specific version
          docker pull ghcr.io/${{ env.REPO_LOWER }}:full-v${{ steps.package_version.outputs.version }}
          ```

          ## Quick Start

          ### Using Docker Compose (Recommended)
          ```bash
          curl -O https://github.com/${{ github.repository }}/releases/download/${CURR_TAG}/docker-compose.yml
          docker compose up -d
          ```

          ### Using Docker Run
          ```bash
          docker run -d \
            --name terminus \
            -p 30001:30001 \
            -v ./terminus-data:/app/db/data \
            -v ./terminus-uploads:/app/uploads \
            --restart unless-stopped \
            ghcr.io/${{ env.REPO_LOWER }}:latest
          ```

          Access Terminus at **http://localhost:30001**

          ## Image Comparison

          | Feature | Backend | Web | Full |
          |---------|---------|-----|------|
          | API Server | âœ… | âœ… | âœ… |
          | Web Interface | âŒ | âœ… | âœ… |
          | Electron Downloads | âŒ | âŒ | âœ… |
          | Image Size | ~200MB | ~300MB | ~500MB* |
          | Use Case | API-only | Standard | Complete |

          *Approximate sizes, actual size varies by architecture

          ## Supported Architectures
          All images support:
          - **linux/amd64** (Intel/AMD 64-bit)
          - **linux/arm64** (ARM 64-bit)

          ## Desktop Applications

          Native desktop applications are available for all major platforms:

          ### ðŸªŸ Windows
          - **Terminus-Setup.exe** - Windows Installer (recommended)
          - **Terminus-Windows-Portable.zip** - Portable version (no installation required)

          ### ðŸ§ Linux
          - **Terminus.AppImage** - Universal Linux application (recommended)
          - **Terminus.tar.gz** - Linux archive
          - **Terminus-Linux-Portable.zip** - Portable version

          ### ðŸŽ macOS
          - **Terminus-macOS.dmg** - macOS installer
          - Requires macOS 10.13 or later

          **Note**: Desktop apps can connect to a central Terminus server (backend variant) or run standalone.

          ## What's New
          See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
          EOF

          # Create release
          gh release create "${CURR_TAG}" \
            --title "Terminus ${CURR_TAG}" \
            --notes-file release_notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload docker-compose.yml to Release
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: AButler/upload-release-assets@v2.0
        with:
          files: "docker-compose.yml"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "v${{ steps.package_version.outputs.version }}"

      - name: Upload Dockerfile to Release
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: AButler/upload-release-assets@v2.0
        with:
          files: "Dockerfile"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "v${{ steps.package_version.outputs.version }}"

      # Download all Electron build artifacts
      - name: Download Windows Portable
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-Windows-Portable
          path: ./artifacts

      - name: Download Windows Installer
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-Windows-Installer
          path: ./artifacts

      - name: Download Linux AppImage
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-Linux-AppImage
          path: ./artifacts

      - name: Download Linux tar.gz
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-Linux-targz
          path: ./artifacts

      - name: Download Linux Portable
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-Linux-Portable
          path: ./artifacts

      - name: Download macOS DMG
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Terminus-macOS-DMG
          path: ./artifacts

      # Upload all Electron builds to release
      - name: Upload Electron Apps to Release
        if: steps.version_check.outputs.versionChanged == 'true'
        uses: AButler/upload-release-assets@v2.0
        with:
          files: "artifacts/*"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "v${{ steps.package_version.outputs.version }}"

  summary:
    name: Deployment Summary
    needs: [publish, build-electron-windows, build-electron-linux, build-electron-macos]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set repository name lowercase
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Summary

          **Version:** v${{ steps.version.outputs.version }}

          ### Docker Images Published

          | Variant | Image Tag | Description |
          |---------|-----------|-------------|
          | Backend | `ghcr.io/${{ env.REPO_LOWER }}:backend` | API server only |
          | Web | `ghcr.io/${{ env.REPO_LOWER }}:web` | Web UI + API (recommended) |
          | Full | `ghcr.io/${{ env.REPO_LOWER }}:full` | Web + Electron downloads |
          | Latest | `ghcr.io/${{ env.REPO_LOWER }}:latest` | Points to web variant |

          ### Version Tags
          All variants also available with version tags:
          - `:backend-v${{ steps.version.outputs.version }}`
          - `:web-v${{ steps.version.outputs.version }}`
          - `:full-v${{ steps.version.outputs.version }}`
          - `:v${{ steps.version.outputs.version }}` (web variant)

          ### Platforms
          - âœ… linux/amd64
          - âœ… linux/arm64

          ### Desktop Applications Built

          | Platform | Files | Status |
          |----------|-------|--------|
          | ðŸªŸ Windows | Installer + Portable | âœ… Built |
          | ðŸ§ Linux | AppImage + tar.gz + Portable | âœ… Built |
          | ðŸŽ macOS | DMG | âœ… Built |

          All desktop apps are automatically uploaded to the GitHub Release.

          ### Quick Start

          **Docker:**
          ```bash
          docker pull ghcr.io/${{ env.REPO_LOWER }}:latest
          docker run -d -p 30001:30001 --name terminus ghcr.io/${{ env.REPO_LOWER }}:latest
          ```
          Access at: http://localhost:30001

          **Desktop App:**
          Download from [Releases](https://github.com/${{ github.repository }}/releases/latest)
          EOF
