name: Build VS Code Extension

on:
  push:
    branches: [main]
    paths:
      - 'vscode-extension/**'
      - 'src/backend/**'
      - 'src/ui/**'
      - '.github/workflows/vscode-extension.yml'
  workflow_dispatch:

jobs:
  build-extension:
    name: Build VS Code Extension (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
          - os: ubuntu-latest
            target: win32-x64
          - os: macos-latest
            target: darwin-x64
          - os: macos-14
            target: darwin-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install VS Code CLI (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
          sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
          rm -f packages.microsoft.gpg
          sudo apt-get update
          sudo apt-get install -y code
          code --version

      - name: Install VS Code CLI (macOS)
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-14'
        run: |
          brew install --cask visual-studio-code
          code --version

      - name: Build backend
        run: npm run build:backend

      - name: Build frontend for VS Code
        run: npm run build:vscode:frontend

      - name: Copy backend to extension dist
        run: |
          mkdir -p vscode-extension/dist/backend
          cp -r dist/backend/* vscode-extension/dist/backend/

      - name: Build extension
        working-directory: vscode-extension
        run: |
          npm install
          VSCODE_ELECTRON_VERSION=$(code --version | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "29.0.0")
          export VSCODE_ELECTRON_VERSION
          echo "Using VS Code Electron version: $VSCODE_ELECTRON_VERSION"
          npm run compile

      - name: Package extension
        working-directory: vscode-extension
        run: |
          npx vsce package --target ${{ matrix.target }}
          ls -lh *.vsix

      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terminus-vscode-${{ matrix.target }}
          path: vscode-extension/*.vsix
          retention-days: 90

  summary:
    name: Build Summary
    needs: [build-extension]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## VS Code Extension Build Summary

          **Version:** v${{ steps.version.outputs.version }}

          ### Platform-Specific VSIX Files Built

          | Platform | File | Target |
          |----------|------|--------|
          | Windows x64 | `terminus-vscode-${{ steps.version.outputs.version }}-win32-x64.vsix` | win32-x64 |
          | Linux x64 | `terminus-vscode-${{ steps.version.outputs.version }}-linux-x64.vsix` | linux-x64 |
          | macOS Intel | `terminus-vscode-${{ steps.version.outputs.version }}-darwin-x64.vsix` | darwin-x64 |
          | macOS Apple Silicon | `terminus-vscode-${{ steps.version.outputs.version }}-darwin-arm64.vsix` | darwin-arm64 |

          ### Installation Instructions

          **From Artifacts:**
          Download the appropriate VSIX file from the build artifacts and install:
          ```bash
          code --install-extension terminus-vscode-${{ steps.version.outputs.version }}-<platform>.vsix
          ```

          **From VS Code:**
          1. Open VS Code
          2. Go to Extensions (Ctrl+Shift+X / Cmd+Shift+X)
          3. Click on the ... menu
          4. Select "Install from VSIX..."
          5. Choose the downloaded file

          ### Testing

          1. Install the extension
          2. Open VS Code
          3. Click the Terminus icon in the Activity Bar
          4. Verify the sidebar shows "SSH Hosts"
          5. Try adding a test host
          6. Verify backend starts (check Output panel)

          ### Next Steps

          - Test on each platform
          - Verify native modules (node-pty, better-sqlite3) work correctly
          - Test terminal connections
          - Test file manager functionality
          - Publish to VS Code Marketplace when ready
          EOF
