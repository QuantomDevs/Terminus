name: Dependabot Auto-Merge

on:
  # Run daily to check for PRs older than 7 days
  schedule:
    - cron: "0 10 * * *"  # Every day at 10:00 UTC
  # Allow manual trigger
  workflow_dispatch:
  # Also run when PRs are updated
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs after 7 days
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get all Dependabot PRs
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all open Dependabot PRs with automerge label
          OPEN_PRS=$(gh pr list \
            --author "app/dependabot" \
            --label "automerge" \
            --state open \
            --json number,createdAt,title,headRefName,statusCheckRollup \
            --limit 10)

          echo "Found PRs:"
          echo "$OPEN_PRS" | jq -r '.[] | "PR #\(.number): \(.title) (created: \(.createdAt))"'

          echo "prs=$OPEN_PRS" >> $GITHUB_OUTPUT

      - name: Auto-merge eligible PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRS='${{ steps.get_prs.outputs.prs }}'

          # Get current date in seconds since epoch
          CURRENT_DATE=$(date +%s)

          # 7 days in seconds (7 * 24 * 60 * 60)
          SEVEN_DAYS=604800

          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            PR_CREATED=$(echo "$pr" | jq -r '.createdAt')
            PR_STATUS=$(echo "$pr" | jq -r '.statusCheckRollup[]?.conclusion // "unknown"')

            # Convert PR creation date to seconds since epoch
            PR_DATE=$(date -d "$PR_CREATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PR_CREATED" +%s)

            # Calculate age in seconds
            AGE=$((CURRENT_DATE - PR_DATE))
            AGE_DAYS=$((AGE / 86400))

            echo "----------------------------------------"
            echo "PR #$PR_NUMBER: $PR_TITLE"
            echo "Created: $PR_CREATED"
            echo "Age: $AGE_DAYS days"
            echo "Status: $PR_STATUS"

            # Check if PR is older than 7 days
            if [ $AGE -ge $SEVEN_DAYS ]; then
              echo "âœ… PR is older than 7 days"

              # Check if all status checks passed
              if echo "$PR_STATUS" | grep -q "success\|skipped"; then
                echo "âœ… Status checks passed or skipped"
                echo "ðŸ”„ Auto-merging PR #$PR_NUMBER..."

                # Enable auto-merge with squash
                gh pr merge $PR_NUMBER \
                  --squash \
                  --auto \
                  --delete-branch \
                  --body "ðŸ¤– Automatically merged after 7 days with passing checks"

                echo "âœ… Auto-merge enabled for PR #$PR_NUMBER"
              else
                echo "âŒ Status checks not passed - skipping auto-merge"
              fi
            else
              DAYS_REMAINING=$((7 - AGE_DAYS))
              echo "â³ PR is only $AGE_DAYS days old - will auto-merge in $DAYS_REMAINING days"
            fi
          done

      - name: Summary
        run: |
          echo "## ðŸ¤– Dependabot Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Checked all open Dependabot PRs" >> $GITHUB_STEP_SUMMARY
          echo "â° PRs older than 7 days with passing checks will be auto-merged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Age threshold**: 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge method**: Squash" >> $GITHUB_STEP_SUMMARY
          echo "- **Delete branch**: Yes" >> $GITHUB_STEP_SUMMARY
